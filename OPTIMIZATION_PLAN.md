# 项目优化计划

本文档旨在记录 `vscode-markdown-shiki-preview` 项目的潜在优化点和未来功能规划，以便于跟踪开发进度和进行持续改进。

---

## 1. 性能优化

提升扩展的响应速度和资源利用效率。

- [x] **功能点**: **引入 DOM Diffing 机制，实现增量更新**
    - **现状与问题**: 每次内容变更时，整个 Webview 的 `innerHTML` 会被完全替换。这在频繁编辑或处理大型文件时，会导致不必要的浏览器重绘/重排，有时会引起预览闪烁。
    - **优化方案**:
        1.  改造 `ContentManager`，当内容更新时，不再生成完整的 HTML 文档，而是只通过 `postMessage` 将渲染后的核心 HTML *内容片段* 发送到 Webview 脚本。
        2.  在 `webview.js` 中，引入一个轻量级的 DOM-diffing 库（例如 `morphdom`）。
        3.  Webview 脚本接收到新的 HTML 片段后，使用该库将其与当前的 DOM 进行比对，并只对发生变化的节点执行最小化的、精准的 DOM 更新。
    - **预期收益**: 彻底消除预览更新时的闪烁感，显著提升编辑时的流畅度和响应速度，降低 CPU 占用。

- [x] **功能点**: **Shiki 语言和主题的按需加载**
    - **现状与问题**: 扩展在初始化时会加载 Shiki 捆绑的所有语言和主题，这增加了扩展的初始激活时间和内存占用。
    - **优化方案**:
        1.  修改 `ThemeManager` 中 `createHighlighter` 的配置，在初始状态只加载一个常用语言的子集（如 `markdown`, `javascript`, `typescript`, `python` 等）和默认的几个主题。
        2.  改造代码高亮逻辑，当遇到一个当前未加载的语言或主题时，调用 Shiki 提供的 `loadLanguage` 或 `loadTheme` API 进行动态加载。
    - **预期收益**: 加快扩展的激活速度，降低初始内存消耗。
    - **完成状态**: 已于 2025-09-07 完成。实现方式为：初始化时仅加载 `coreLangs` 和 `coreThemes` 数组中定义的核心集。在 `updateTheme` 和 `highlight` 函数中加入了动态 `loadTheme`/`loadLanguage` 的逻辑。

- [x] **功能点**: **Mermaid.js 的条件加载**
    - **现状与问题**: 无论当前文档是否包含 Mermaid 图表，`mermaid.js` 脚本都会被注入到 HTML 模板中。
    - **优化方案**: 在 `ContentManager` 渲染 HTML 前，先快速扫描文档内容是否包含 ` ```mermaid ` 代码块。只有在包含的情况下，才在最终生成的 HTML 中加入 `mermaid.js` 的 `<script>` 标签。
    - **预期收益**: 对于不含图表的文档，减少了不必要的 JavaScript 解析和执行开销。

---

## 2. 代码结构与可维护性

提升代码质量，使其更易于理解、测试和扩展。

- [ ] **功能点**: **全面采用依赖注入 (Dependency Injection)**
    - **现状与问题**: 各个 `Manager` 实例在 `PreviewProvider` 中被直接创建和持有，形成了一定的耦合。配置项通过全局的 `configService` 在多处被直接调用，隐藏了模块间的真实依赖。
    - **优化方案**:
        1.  在 `index.ts` 的 `activate` 函数中建立一个“组合根”（Composition Root）。在这里统一创建所有服务/管理器实例。
        2.  明确地将一个类所依赖的其他服务通过其构造函数传入，而不是在类内部去获取。
    - **预期收益**: 模块间依赖关系变得清晰，代码解耦，单元测试变得非常容易（可以轻松传入模拟的依赖项）。

- [ ] **功能点**: **强化响应式的配置变更处理**
    - **现状与问题**: 部分配置的更新是通过监听事件，但有些是在渲染时主动获取的。
    - **优化方案**: 让各个 `Manager` 显式地订阅它们所关心的所有配置项的变更事件 (`onConfigChange`)。当事件触发时，再执行相应的更新逻辑，形成一个清晰、单向的数据流。
    - **预期收益**: 代码逻辑更清晰，行为更可预测，更容易追踪状态变化。

---

## 3. 用户体验 (UX)

打磨产品细节，提升用户的综合使用感受。

- [ ] **功能点**: **增加加载状态提示**
    - **现状与问题**: 首次打开预览或处理大型文件时，预览窗口可能会短暂显示为空白。
    - **优化方案**: 在 Webview 的 HTML 模板中，默认包含一个加载指示器（如 CSS spinner）。当后台正在进行 Markdown 渲染时，显示该指示器。渲染完成后，通过 `postMessage` 通知 Webview 脚本隐藏加载动画并显示内容。
    - **预期收益**: 提供积极的用户反馈，避免了白屏带来的困惑。

- [ ] **功能点**: **在预览中优雅地显示错误**
    - **现状与问题**: 如果 Mermaid 语法错误或主题加载失败，错误信息主要输出在开发控制台中，普通用户难以察觉。
    - **优化方案**: 捕获渲染过程中的各类错误。当错误发生时，在预览中对应的位置渲染一个醒目的错误提示框（例如，一个带有红色边框和错误详情的 `<pre>` 块），而不是让该部分留白或崩溃。
    - **预期收益**: 用户能立刻知道哪里出了问题以及原因，极大地提升了扩展的可用性。

- [ ] **功能点**: **增强设置的可见性**
    - **现状与问题**: 用户可能不知道有哪些可用的配置项来定制预览效果。
    - **优化方案**: 新增一个命令 `Markdown Preview: Open Settings`。当用户执行该命令时，调用 VSCode API 直接打开设置界面，并自动搜索过滤出本扩展的所有配置项 (`@ext:fxzer.vscode-markdown-shiki-preview`)。
    - **预期收益**: 方便用户发现和修改扩展的所有可配置选项。

---

## 4. 功能扩展

在现有基础上增加更多实用功能。

- [ ] **功能点**: **导出功能**
    - **现状与问题**: 预览结果只能在 VSCode 中查看，无法分享或存档。
    - **优化方案**:
        1.  **基础**: 增加一个“导出为 HTML”的命令，将当前预览的最终 HTML（包括内联的 CSS 样式）保存为一个独立的 `.html` 文件。
        2.  **进阶**: 考虑通过 [Puppeteer](https://pptr.dev/) 实现“导出为 PDF”或“导出为图片”的功能（可能需要用户额外安装依赖）。
    - **预期收益**: 满足用户分享和存档预览结果的常见需求。

- [ ] **功能点**: **支持更多 markdown-it 插件**
    - **现状与问题**: 当前 Markdown 语法支持范围有限。
    - **优化方案**: 增加对更多常用 `markdown-it` 插件的支持，并将它们的启用/禁用做成可配置的选项。例如：
        - `markdown-it-footnote` (脚注)
        - `markdown-it-task-lists` (任务列表 `[ ]` 和 `[x]`)
        - `markdown-it-attrs` (为元素添加自定义属性)
    - **预期收益**: 增强 Markdown 的表现力，满足更多高级用户的需求。

- [ ] **功能点**: **支持工作区级别的主题配置**
    - **现状与问题**: 主题配置是全局的，无法为不同项目设置不同的预览主题。
    - **优化方案**: 允许用户在项目的 `.vscode/settings.json` 中设置一个特定的预览主题 (`markdownPreview.currentTheme`)，使其优先级高于用户的全局设置。
    - **预期收益**: 提升了灵活性，用户可以为不同类型的项目（如个人博客、公司文档）定义不同的预览风格。
